{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.36.1.42791",
      "templateHash": "3050485240988654035"
    }
  },
  "parameters": {
    "aiFoundryName": {
      "type": "string",
      "defaultValue": "foundy",
      "maxLength": 9,
      "metadata": {
        "description": "The name of the Azure AI Foundry resource."
      }
    },
    "projectName": {
      "type": "string",
      "defaultValue": "project",
      "metadata": {
        "description": "The name of your project"
      }
    },
    "projectDescription": {
      "type": "string",
      "defaultValue": "some description",
      "metadata": {
        "description": "The description of your project"
      }
    },
    "projectDisplayName": {
      "type": "string",
      "defaultValue": "project_display_name",
      "metadata": {
        "description": "The display name of your project"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "westus",
      "allowedValues": [
        "australiaeast",
        "canadaeast",
        "eastus",
        "eastus2",
        "francecentral",
        "japaneast",
        "koreacentral",
        "norwayeast",
        "polandcentral",
        "southindia",
        "swedencentral",
        "switzerlandnorth",
        "uaenorth",
        "uksouth",
        "westus",
        "westus3",
        "westeurope",
        "southeastasia"
      ],
      "metadata": {
        "description": "The Azure region where your AI Foundry resource and project will be created."
      }
    },
    "existingAoaiResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The existing Azure OpenAI resource ID."
      }
    },
    "createAppInsights": {
      "type": "bool",
      "defaultValue": true,
      "allowedValues": [
        true,
        false
      ],
      "metadata": {
        "description": "True/False if you want to create an Azure Application Insights resource for the project."
      }
    },
    "appInsightsName": {
      "type": "string",
      "defaultValue": "foundryappinsights",
      "metadata": {
        "description": "The name of the App Insights resource to create"
      }
    },
    "azureDeployName": {
      "type": "string",
      "defaultValue": "[utcNow()]"
    }
  },
  "variables": {
    "accountName": "[format('{0}{1}', parameters('aiFoundryName'), substring(uniqueString(parameters('azureDeployName')), 0, 4))]",
    "byoAoaiConnectionName": "aoaiConnection",
    "existingAoaiResourceIdParts": "[split(parameters('existingAoaiResourceId'), '/')]",
    "existingAoaiResourceIdSubId": "[variables('existingAoaiResourceIdParts')[2]]",
    "existingAoaiResourceIdRgName": "[variables('existingAoaiResourceIdParts')[4]]",
    "existingAoaiResourceIdName": "[variables('existingAoaiResourceIdParts')[8]]"
  },
  "resources": {
    "project::byoAoaiConnection": {
      "type": "Microsoft.CognitiveServices/accounts/projects/connections",
      "apiVersion": "2025-04-01-preview",
      "name": "[format('{0}/{1}/{2}', variables('accountName'), parameters('projectName'), variables('byoAoaiConnectionName'))]",
      "properties": {
        "category": "AzureOpenAI",
        "target": "[reference('existingAoaiResource').endpoint]",
        "authType": "AAD",
        "metadata": {
          "ApiType": "Azure",
          "ResourceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('existingAoaiResourceIdSubId'), variables('existingAoaiResourceIdRgName')), 'Microsoft.CognitiveServices/accounts', variables('existingAoaiResourceIdName'))]",
          "location": "[reference('existingAoaiResource', '2023-05-01', 'full').location]"
        }
      },
      "dependsOn": [
        "existingAoaiResource",
        "project"
      ]
    },
    "project::appInsightsConnections": {
      "condition": "[parameters('createAppInsights')]",
      "type": "Microsoft.CognitiveServices/accounts/projects/connections",
      "apiVersion": "2025-04-01-preview",
      "name": "[format('{0}/{1}/{2}', variables('accountName'), parameters('projectName'), parameters('appInsightsName'))]",
      "properties": {
        "category": "AppInsights",
        "target": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]",
        "authType": "ApiKey",
        "credentials": {
          "key": "[reference('appInsights').ConnectionString]"
        },
        "metadata": {
          "ApiType": "Azure",
          "ResourceId": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
        }
      },
      "dependsOn": [
        "appInsights",
        "project"
      ]
    },
    "existingAoaiResource": {
      "existing": true,
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2023-05-01",
      "subscriptionId": "[variables('existingAoaiResourceIdSubId')]",
      "resourceGroup": "[variables('existingAoaiResourceIdRgName')]",
      "name": "[variables('existingAoaiResourceIdName')]"
    },
    "appInsights": {
      "condition": "[parameters('createAppInsights')]",
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[parameters('appInsightsName')]",
      "location": "[parameters('location')]",
      "kind": "web",
      "properties": {
        "Application_Type": "web"
      }
    },
    "account": {
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2025-04-01-preview",
      "name": "[variables('accountName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "S0"
      },
      "kind": "AIServices",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "allowProjectManagement": true,
        "customSubDomainName": "[variables('accountName')]",
        "networkAcls": {
          "defaultAction": "Allow",
          "virtualNetworkRules": [],
          "ipRules": []
        },
        "publicNetworkAccess": "Enabled",
        "disableLocalAuth": false
      }
    },
    "project": {
      "type": "Microsoft.CognitiveServices/accounts/projects",
      "apiVersion": "2025-04-01-preview",
      "name": "[format('{0}/{1}', variables('accountName'), parameters('projectName'))]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "description": "[parameters('projectDescription')]",
        "displayName": "[parameters('projectDisplayName')]"
      },
      "dependsOn": [
        "account"
      ]
    },
    "accountCapabilityHost": {
      "type": "Microsoft.CognitiveServices/accounts/capabilityHosts",
      "apiVersion": "2025-04-01-preview",
      "name": "[format('{0}/{1}', variables('accountName'), format('{0}-capHost', variables('accountName')))]",
      "properties": {
        "capabilityHostKind": "Agents"
      },
      "dependsOn": [
        "account",
        "project"
      ]
    },
    "projectCapabilityHost": {
      "type": "Microsoft.CognitiveServices/accounts/projects/capabilityHosts",
      "apiVersion": "2025-04-01-preview",
      "name": "[format('{0}/{1}/{2}', variables('accountName'), parameters('projectName'), format('{0}-capHost', parameters('projectName')))]",
      "properties": {
        "capabilityHostKind": "Agents",
        "aiServicesConnections": [
          "[format('{0}', variables('byoAoaiConnectionName'))]"
        ]
      },
      "dependsOn": [
        "accountCapabilityHost",
        "project"
      ]
    }
  },
  "outputs": {
    "projectEndpoint": {
      "type": "string",
      "value": "[reference('project').endpoints['AI Foundry API']]"
    },
    "accountName": {
      "type": "string",
      "value": "[variables('accountName')]"
    },
    "projectName": {
      "type": "string",
      "value": "[parameters('projectName')]"
    }
  }
}