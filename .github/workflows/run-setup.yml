name: Run Setup
# This action can be run on-demand against a branch.
# It attempts to auto-fix some errors in the most recently updated sample in the branch:
#    Builds main.bicep -> azuredeploy.json
#    Attempts some fixes with the metadata

# To run/debug locally, try https://github.com/nektos/act
# Actions documentation: https://docs.github.com/en/actions/reference

on:
  push:
    branches:
      - main
    paths:
      - infrastructure/infrastructure-setup-bicep/**
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  main:
    runs-on: ubuntu-latest
    steps:

      # Checkout the PR branch (or main for pushes)
      - name: Checkout source branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0

      # Setup .NET Core
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1.8.0

      # Install Bicep CLI
      - name: Install Bicep
        run: |
          INSTALL_PATH="$RUNNER_TEMP/bicep"
          BICEP_PATH="$RUNNER_TEMP/bicep/bicep"
          mkdir -p $INSTALL_PATH
          curl -sLo bicep https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64
          chmod +x ./bicep
          sudo mv ./bicep $INSTALL_PATH
          echo "BICEP_PATH=$BICEP_PATH" >> $GITHUB_ENV
          $BICEP_PATH --version

      # Install PowerShell
      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https software-properties-common
          wget -q https://packages.microsoft.com/config/ubuntu/16.04/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell

      # Your build steps here
      - name: Find and scan Bicep files
        run: |
          git status
          pwd
          cd $GITHUB_WORKSPACE
          pwd

          MODIFIED_FILES=$(git log --pretty="" --name-only -n 100 origin/main... | fgrep -v ".github")

          if [ -z "$MODIFIED_FILES" ]; then
            echo "No modified files found."
            exit 1
          fi

          echo "Modified files:"
          echo "$MODIFIED_FILES"

          IFS=$'\n' read -r -a MODIFIED_FILES_ARRAY <<< "$MODIFIED_FILES"

          MAINBICEP_PATHS=()
          AZDEPLOYJSON_PATHS=()

          for FILE in "${MODIFIED_FILES_ARRAY[@]}"; do
              echo "Processing: $FILE"
              TESTFOLDER_PATH=$(dirname "$FILE")
              FOUNDBICEP_PATH=""
              FOUNDJSON_PATH=""
              while [ "$TESTFOLDER_PATH" != "." ]; do
                  echo "Looking in: $TESTFOLDER_PATH"
                  ls -l "$TESTFOLDER_PATH"
                  if [ -z "$FOUNDBICEP_PATH" ] && [ -f "$TESTFOLDER_PATH/main.bicep" ]; then
                      FOUNDBICEP_PATH="$TESTFOLDER_PATH/main.bicep"
                      echo "Found main.bicep: $FOUNDBICEP_PATH"
                  fi
                  if [ -z "$FOUNDJSON_PATH" ] && [ -f "$TESTFOLDER_PATH/azuredeploy.json" ]; then
                      FOUNDJSON_PATH="$TESTFOLDER_PATH/azuredeploy.json"
                      echo "Found azuredeploy.json: $FOUNDJSON_PATH"
                  fi
                  if [ -n "$FOUNDBICEP_PATH" ] && [ -n "$FOUNDJSON_PATH" ]; then
                      break
                  fi
                  TESTFOLDER_PATH=$(dirname "$TESTFOLDER_PATH")
              done
              if [ -n "$FOUNDBICEP_PATH" ]; then
                  MAINBICEP_PATHS+=("$FOUNDBICEP_PATH")
              fi
              if [ -n "$FOUNDJSON_PATH" ]; then
                  AZDEPLOYJSON_PATHS+=("$FOUNDJSON_PATH")
              fi
          done

          echo "MAINBICEP_PATHS=${MAINBICEP_PATHS[*]}" >> $GITHUB_ENV
          echo "AZDEPLOYJSON_PATHS=${AZDEPLOYJSON_PATHS[*]}" >> $GITHUB_ENV

      - name: Build Bicep files
        run: |
          IFS=' ' read -ra MAINBICEP_PATHS_ARRAY <<< "$MAINBICEP_PATHS"
          IFS=' ' read -ra AZDEPLOYJSON_PATHS_ARRAY <<< "$AZDEPLOYJSON_PATHS"

          if [ ${#MAINBICEP_PATHS_ARRAY[@]} -ne ${#AZDEPLOYJSON_PATHS_ARRAY[@]} ]; then
              echo "Error: Mismatch in number of Bicep files and output JSON paths."
              exit 1
          fi

          for i in "${!MAINBICEP_PATHS_ARRAY[@]}"; do
              MAINBICEP_FILE="${MAINBICEP_PATHS_ARRAY[$i]}"
              AZDEPLOYJSON_FILE="${AZDEPLOYJSON_PATHS_ARRAY[$i]}"
              if [ -f "$MAINBICEP_FILE" ]; then
                  echo "Building: $MAINBICEP_FILE -> $AZDEPLOYJSON_FILE"
                  $BICEP_PATH build "$MAINBICEP_FILE" --outfile "$AZDEPLOYJSON_FILE"
              else
                  echo "Warning: Bicep file not found: $MAINBICEP_FILE"
              fi
          done

      # Auto-commit and push changes to branch (works for PR and main)
      - name: Auto-commit and push if needed
        if: always()
        run: |
          git config --global user.email "foundry-samples@noreply.github.com"
          git config --global user.name "foundry-samples automation"
          git add * || true
          if ! git diff-index --quiet HEAD --; then
            git commit -m "Automatic fixes"
            BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME:-${GITHUB_REF##*/}}}"
            git push origin HEAD:refs/heads/"$BRANCH_NAME"
          else
            echo "No changes to commit."
          fi
